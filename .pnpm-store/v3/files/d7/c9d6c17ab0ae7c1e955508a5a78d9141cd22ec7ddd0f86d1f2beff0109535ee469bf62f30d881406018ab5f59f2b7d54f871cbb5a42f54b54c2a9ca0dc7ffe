import ESM_COMPAT_Module from 'node:module';
import { fileURLToPath } from 'node:url';
import { dirname, resolve, join } from 'node:path';
import '../chunk-HVK6626C.mjs';
import { validateConfigurationFiles, loadAllPresets, getInterpretedFile } from 'storybook/internal/common';
import { vitestTransform, readConfig } from 'storybook/internal/csf-tools';
import { MainFileMissingError } from 'storybook/internal/server-errors';

const __filename = fileURLToPath(import.meta.url);
dirname(__filename);
ESM_COMPAT_Module.createRequire(import.meta.url);
var defaultOptions={storybookScript:void 0,configDir:void 0,storybookUrl:"http://localhost:6006"},extractTagsFromPreview=async configDir=>{let previewConfigPath=getInterpretedFile(join(resolve(configDir),"preview"));return previewConfigPath?(await readConfig(previewConfigPath)).getFieldValue(["tags"])??[]:[]},storybookTest=options=>{let finalOptions={...defaultOptions,...options,tags:{include:options?.tags?.include??["test"],exclude:options?.tags?.exclude??[],skip:options?.tags?.skip??[]}};process.env.DEBUG&&(finalOptions.debug=!0);let storybookUrl=finalOptions.storybookUrl||defaultOptions.storybookUrl;process.env.__STORYBOOK_URL__=storybookUrl,process.env.__STORYBOOK_SCRIPT__=finalOptions.storybookScript;let stories;finalOptions.configDir?finalOptions.configDir=resolve(process.cwd(),finalOptions.configDir):finalOptions.configDir=resolve(join(process.cwd(),".storybook"));let previewLevelTags;return {name:"vite-plugin-storybook-test",enforce:"pre",async config(config){let configDir=finalOptions.configDir;try{await validateConfigurationFiles(configDir);}catch{throw new MainFileMissingError({location:configDir,source:"vitest"})}let presets=await loadAllPresets({configDir,corePresets:[],overridePresets:[],packageJson:{}});stories=await presets.apply("stories",[]),previewLevelTags=await extractTagsFromPreview(configDir);let framework=await presets.apply("framework",void 0),frameworkName=typeof framework=="string"?framework:framework.name;config.test??={},config.test.env??={},config.test.env={...config.test.env,__STORYBOOK_URL__:storybookUrl},config.test.browser&&(config.test.browser.screenshotFailures??=!1),config.resolve??={},config.resolve.conditions??=[],config.resolve.conditions.push("storybook","stories","test"),config.test.setupFiles??=[],typeof config.test.setupFiles=="string"&&(config.test.setupFiles=[config.test.setupFiles]),config.test.setupFiles.push("@storybook/experimental-addon-test/internal/setup-file"),finalOptions.storybookScript&&(config.test.globalSetup=config.test.globalSetup??[],typeof config.test.globalSetup=="string"&&(config.test.globalSetup=[config.test.globalSetup]),config.test.globalSetup.push("@storybook/experimental-addon-test/internal/global-setup")),config.test.server??={},config.test.server.deps??={},config.test.server.deps.inline??=[],Array.isArray(config.test.server.deps.inline)&&config.test.server.deps.inline.push("@storybook/experimental-addon-test"),frameworkName?.includes("vue3")&&(config.define??={},config.define.__VUE_PROD_HYDRATION_MISMATCH_DETAILS__="false");},async transform(code,id){if(process.env.VITEST!=="true")return code;if(id.match(/(story|stories)\.[cm]?[jt]sx?$/))return vitestTransform({code,fileName:id,configDir:finalOptions.configDir,tagsFilter:finalOptions.tags,stories,previewLevelTags})}}},vitest_plugin_default=storybookTest;

export { vitest_plugin_default as default, storybookTest };
