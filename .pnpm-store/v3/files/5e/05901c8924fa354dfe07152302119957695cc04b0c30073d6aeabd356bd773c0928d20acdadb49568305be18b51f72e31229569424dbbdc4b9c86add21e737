'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var path = require('path');
var common = require('storybook/internal/common');
var csfTools = require('storybook/internal/csf-tools');
var serverErrors = require('storybook/internal/server-errors');

var defaultOptions={storybookScript:void 0,configDir:void 0,storybookUrl:"http://localhost:6006"},extractTagsFromPreview=async configDir=>{let previewConfigPath=common.getInterpretedFile(path.join(path.resolve(configDir),"preview"));return previewConfigPath?(await csfTools.readConfig(previewConfigPath)).getFieldValue(["tags"])??[]:[]},storybookTest=options=>{let finalOptions={...defaultOptions,...options,tags:{include:options?.tags?.include??["test"],exclude:options?.tags?.exclude??[],skip:options?.tags?.skip??[]}};process.env.DEBUG&&(finalOptions.debug=!0);let storybookUrl=finalOptions.storybookUrl||defaultOptions.storybookUrl;process.env.__STORYBOOK_URL__=storybookUrl,process.env.__STORYBOOK_SCRIPT__=finalOptions.storybookScript;let stories;finalOptions.configDir?finalOptions.configDir=path.resolve(process.cwd(),finalOptions.configDir):finalOptions.configDir=path.resolve(path.join(process.cwd(),".storybook"));let previewLevelTags;return {name:"vite-plugin-storybook-test",enforce:"pre",async config(config){let configDir=finalOptions.configDir;try{await common.validateConfigurationFiles(configDir);}catch{throw new serverErrors.MainFileMissingError({location:configDir,source:"vitest"})}let presets=await common.loadAllPresets({configDir,corePresets:[],overridePresets:[],packageJson:{}});stories=await presets.apply("stories",[]),previewLevelTags=await extractTagsFromPreview(configDir);let framework=await presets.apply("framework",void 0),frameworkName=typeof framework=="string"?framework:framework.name;config.test??={},config.test.env??={},config.test.env={...config.test.env,__STORYBOOK_URL__:storybookUrl},config.test.browser&&(config.test.browser.screenshotFailures??=!1),config.resolve??={},config.resolve.conditions??=[],config.resolve.conditions.push("storybook","stories","test"),config.test.setupFiles??=[],typeof config.test.setupFiles=="string"&&(config.test.setupFiles=[config.test.setupFiles]),config.test.setupFiles.push("@storybook/experimental-addon-test/internal/setup-file"),finalOptions.storybookScript&&(config.test.globalSetup=config.test.globalSetup??[],typeof config.test.globalSetup=="string"&&(config.test.globalSetup=[config.test.globalSetup]),config.test.globalSetup.push("@storybook/experimental-addon-test/internal/global-setup")),config.test.server??={},config.test.server.deps??={},config.test.server.deps.inline??=[],Array.isArray(config.test.server.deps.inline)&&config.test.server.deps.inline.push("@storybook/experimental-addon-test"),frameworkName?.includes("vue3")&&(config.define??={},config.define.__VUE_PROD_HYDRATION_MISMATCH_DETAILS__="false");},async transform(code,id){if(process.env.VITEST!=="true")return code;if(id.match(/(story|stories)\.[cm]?[jt]sx?$/))return csfTools.vitestTransform({code,fileName:id,configDir:finalOptions.configDir,tagsFilter:finalOptions.tags,stories,previewLevelTags})}}},vitest_plugin_default=storybookTest;

exports.default = vitest_plugin_default;
exports.storybookTest = storybookTest;
